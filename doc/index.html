<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Strict//EN">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"></meta><title>DRAKMA - A Common Lisp HTTP client</title><meta name="description" content="
    Drakma is a full-featured HTTP client implemented in Common Lisp.
    It knows how to handle HTTP/1.1 chunking,
    persistent connections, re-usable sockets, SSL, continuable
    uploads, file uploads, cookies, and more.
  "></meta><style type="text/css">
  body { background-color: #ffffff }
  pre { padding:5px; background-color:#e0e0e0 }
  pre.none { padding:5px; background-color:#ffffff }
  h3, h4, h5 { text-decoration: underline; }
  .entry-type { padding-left: 1em; font-size: 60%; font-style: italic }
  a { text-decoration: none; padding: 1px 2px 1px 2px; }
  a:visited { text-decoration: none; padding: 1px 2px 1px 2px; }
  a:hover { text-decoration: none; padding: 1px 1px 1px 1px; border: 1px solid #000000; } 
  a:focus { text-decoration: none; padding: 1px 2px 1px 2px; border: none; }
  a.none { text-decoration: none; padding: 0; }
  a.none:visited { text-decoration: none; padding: 0; } 
  a.none:hover { text-decoration: none; border: none; padding: 0; } 
  a.none:focus { text-decoration: none; border: none; padding: 0; } 
  a.noborder { text-decoration: none; padding: 0; } 
  a.noborder:visited { text-decoration: none; padding: 0; } 
  a.noborder:hover { text-decoration: none; border: none; padding: 0; } 
  a.noborder:focus { text-decoration: none; border: none; padding: 0; }  
        </style></head><body>
  
  

  <h2>DRAKMA - A Common Lisp HTTP client</h2>

  <blockquote>
    <h3 xmlns=""><a class="none" name="abstract">Abstract</a></h3>
      <p>
        Drakma is a full-featured HTTP client implemented in Common Lisp.
        It knows how to handle <a href="#chunked">HTTP/1.1 chunking</a>,
        <a href="#keep-alive">persistent connections</a>, <a href="#re-use">re-usable sockets</a>, <a href="#force-ssl">SSL</a>, <a href="#cont">continuable
        uploads</a>, <a href="#form-data">file uploads</a>, <a href="#cookie-jar-param">cookies</a>, and more.
      </p>
      <p>
        The code comes with a <a href="http://www.opensource.org/licenses/bsd-license.php">BSD-style
        license</a> so you can basically do with it whatever you want.
      </p>
      <p>
        The preferred method to download, compile and load Drakma is
        via <a href="http://www.quicklisp.org/">Quicklisp</a>.  That
        way, all libraries that Drakma uses are automatically
        downloaded.
      </p>
    
  </blockquote>

  <h3 xmlns=""><a class="none" name="contents">Contents</a></h3>
  <ol xmlns="">
<li><a href="#abstract">Abstract</a></li>
<li><a href="#contents">Contents</a></li>
<li>
<a href="#examples">Examples</a><ol>
<li><a href="#ex-loading">Loading Drakma with Quicklisp</a></li>
<li><a href="#ex-logging">Log headers to the REPL output stream</a></li>
<li><a href="#ex-request-redirect">Requesting a page with redirection</a></li>
<li><a href="#ex-charsets">Requesting a page containing non-ASCII characters</a></li>
<li><a href="#ex-binary-data">Requesting binary data</a></li>
<li><a href="#ex-chunked-https">Chunked transfers and HTTPS</a></li>
<li><a href="#ex-fake-ua">Faking a user agent header</a></li>
<li><a href="#ex-post-and-cookie">Posting data and using cookies</a></li>
<li><a href="#ex-reuse-connection">Reusing a connection to a server</a></li>
<li><a href="#ex-basic-auth">Basic Authorization</a></li>
<li><a href="#ex-response-stream">Reading the response from a stream</a></li>
<li><a href="#ex-assemble-request-content">Piecemeal assembly of request contents</a></li>
<li><a href="#ex-partial-transfers">Partial transfers</a></li>
</ol>
</li>
</ol>
    
  <h3 xmlns=""><a class="none" name="examples">Examples</a></h3>

    <style type="text/css">
      pre { margin-left: 3em; margin-right: 3em; word-wrap: break-word; overflow-x: auto; background: #eee; }
      .repl-output { color: black; }
      .repl-input { font-weight: bold; }
      .headers-out { color: SteelBlue; }
      .headers-in { color: SeaGreen; }
    </style>

    <p>
      Here is a collection of example uses of Drakma to which
      demonstrate some of its features.  In the examples, text is
      color coded to indicate where it comes from (<span class="repl-input">REPL input</span>, <span class="repl-output">REPL output</span>, <span class="headers-out">HTTP headers sent</span> and <span class="headers-in">HTTP headers received</span>).
    </p>

    <h4 xmlns=""><a name="ex-loading">Loading Drakma with Quicklisp</a></h4>
      <pre><span class="repl-output">? </span><span class="repl-input">(ql:quickload :drakma)</span>
<span class="repl-output">To load "drakma":
  Load 1 ASDF system:
    drakma
; Loading "drakma"
To load "cl+ssl":
  Load 1 ASDF system:
    flexi-streams
  Install 8 Quicklisp releases:
    alexandria babel bordeaux-threads cffi cl+ssl
    trivial-features trivial-garbage trivial-gray-streams
; Loading "cl+ssl"
[package trivial-garbage].........................
[package alexandria.0.dev]........................
..................................................
..................................................
[package bordeaux-threads]........................
[package trivial-gray-streams]....................
[package babel-encodings].........................
[package babel]...................................
..................................................
..................................................
..................................................
..................................................
..................................................
..................................................
..................................................
..................................................
..................................................
..................................................
..................................................
..................................................
..................................................
..................................................
..................................................
..................................................
..................................................
..................................................
[package cffi-sys]................................
[package cffi-callbacks]..........................
[package cffi]....................................
..................................................
..................................................
[package cffi-features]...........................
[package cl+ssl].............
; Loading "drakma"
To load "usocket":
  Install 1 Quicklisp release:
    usocket
; Loading "usocket"
[package usocket]...............
; Loading "drakma"
To load "cl-base64":
  Install 1 Quicklisp release:
    cl-base64
; Loading "cl-base64"
[package cl-base64]...........................
; Loading "drakma"
To load "puri":
  Install 1 Quicklisp release:
    puri
; Loading "puri"
[package puri]..............
; Loading "drakma"

(:DRAKMA)
</span>
</pre>
    
    <h4 xmlns=""><a name="ex-logging">Log headers to the REPL output stream</a></h4>

      In the following examples, the headers exchanged between Drakma
      and the HTTP server should be shown, for illustration purposes.
      This can be achieved like so:

      <pre><span class="repl-output">? </span><span class="repl-input">(setf drakma:*header-stream* *standard-output*)</span>
<span class="repl-output">#&lt;SYNONYM-STREAM to *TERMINAL-IO* #x3020006AC7DD&gt;</span>
</pre>
    
    <h4 xmlns=""><a name="ex-request-redirect">Requesting a page with redirection</a></h4>

      Request a page.  Note how Drakma automatically follows the 301
      redirect and how the fourth return value shows the <em>new</em>
      URI.

<pre><span class="repl-output">? </span><span class="repl-input">(drakma:http-request "http://lisp.org/")</span>
<span class="headers-out">GET / HTTP/1.1
Host: lisp.org
User-Agent: Drakma/1.2.9 (Clozure Common Lisp Version 1.8-r15286M  (DarwinX8664); Darwin; 12.2.0; http://weitz.de/drakma/)
Accept: */*
Connection: close
</span>
<span class="headers-in">HTTP/1.1 307  Temporary Redirect
Date: Sun, 09 Dec 2012 08:01:56 GMT
Connection: Close
Server: AllegroServe/1.2.65
Transfer-Encoding: chunked
LOCATION: http://lisp.org/index.html
</span>
<span class="headers-out">GET /index.html HTTP/1.1
Host: lisp.org
User-Agent: Drakma/1.2.9 (Clozure Common Lisp Version 1.8-r15286M  (DarwinX8664); Darwin; 12.2.0; http://weitz.de/drakma/)
Accept: */*
Connection: close
</span>
<span class="headers-in">HTTP/1.1 200  OK
Date: Sun, 09 Dec 2012 08:01:56 GMT
Connection: Close
Server: AllegroServe/1.2.65
Content-Type: text/html
Content-Length: 459
LAST-MODIFIED: Wed, 26 Oct 2011 02:26:26 GMT
</span>
<span class="repl-output">"&lt;HTML&gt;
&lt;HEAD&gt;
  &lt;title&gt;John McCarthy, 1927-2011&lt;/title&gt;
  &lt;STYLE type=\"text/css\"&gt;
    BODY {text-align: center}
  &lt;/STYLE&gt;
&lt;/HEAD&gt;
&lt;BODY&gt;
&lt;h1&gt;John McCarthy&lt;/h1&gt;
&lt;img src=\"jmccolor.jpg\" alt=\"a picture of John McCarthy, from his website\"/&gt;
&lt;h3&gt;1927-2011&lt;/h3&gt;
&lt;br&gt;&lt;br&gt;
&lt;a href=\"http://www-formal.stanford.edu/jmc/\"&gt;John McCarthy's Home Page&lt;/a&gt;&lt;br&gt;
&lt;a href=\"http://news.stanford.edu/news/2011/october/john-mccarthy-obit-102511.html\"&gt;Obituary&lt;/a&gt;
&lt;/BODY&gt;
&lt;/HTML&gt;
"
200
((:DATE . "Sun, 09 Dec 2012 08:01:56 GMT") (:CONNECTION . "Close") (:SERVER . "AllegroServe/1.2.65") (:CONTENT-TYPE . "text/html") (:CONTENT-LENGTH . "459") (:LAST-MODIFIED . "Wed, 26 Oct 2011 02:26:26 GMT"))
#&lt;URI http://lisp.org/index.html&gt;
#&lt;FLEXI-STREAMS:FLEXI-IO-STREAM #x30200155DB1D&gt;
T
" OK"</span>
</pre>
    
    <h4 xmlns=""><a name="ex-charsets">Requesting a page containing non-ASCII characters</a></h4>
      Drakma automatically interprets the 'charset=utf-8' part correctly.

      <pre><span class="repl-output">? </span><span class="repl-input">(subseq (drakma:http-request "http://www.cl.cam.ac.uk/~mgk25/ucs/examples/digraphs.txt") 0 298)</span>
<span class="headers-out">GET /~mgk25/ucs/examples/digraphs.txt HTTP/1.1
Host: www.cl.cam.ac.uk
User-Agent: Drakma/1.2.9 (Clozure Common Lisp Version 1.8-r15286M  (DarwinX8664); Darwin; 12.2.0; http://weitz.de/drakma/)
Accept: */*
Connection: close
</span>
<span class="headers-in">HTTP/1.1 200 OK
Date: Sun, 09 Dec 2012 08:15:04 GMT
Server: Apache/2.2.3 (CentOS)
Last-Modified: Mon, 06 Apr 2009 18:13:43 GMT
ETag: "17cd62-298-466e6dbcd03c0"
Accept-Ranges: bytes
Content-Length: 664
X-UA-Compatible: IE=edge
Connection: close
Content-Type: text/plain; charset=utf-8
</span>
<span class="repl-output">"Latin Digraphs and Ligatures in ISO10646-1

A short table of ligatures and digraphs follows. Some of these may not be
ligatures/digraphs in the technical sense, (for example, æ is a seperate
letter in English), but visually they behave that way.

AÆE : U+00C6
aæe : U+00E6
ſßs : U+00DF
IĲJ : U+0132"</span>
</pre>
    
    <h4 xmlns=""><a name="ex-binary-data">Requesting binary data</a></h4>

      For non-textual content types, a vector of octets is returned.

      <pre><span class="repl-output">? </span><span class="repl-input">(drakma:http-request "http://zappa.com/favicon.ico")</span>
<span class="headers-out">GET /favicon.ico HTTP/1.1
Host: zappa.com
User-Agent: Drakma/1.2.9 (Clozure Common Lisp Version 1.8-r15286M  (DarwinX8664); Darwin; 12.2.0; http://weitz.de/drakma/)
Accept: */*
Connection: close
</span>
<span class="headers-in">HTTP/1.1 200 OK
Date: Sun, 09 Dec 2012 08:15:14 GMT
Server: Apache/2
Last-Modified: Sun, 01 Apr 2007 15:44:59 GMT
ETag: "e2803c-b6-42d0efcaf94c0"
Accept-Ranges: bytes
Content-Length: 182
Vary: Accept-Encoding,User-Agent
Connection: close
Content-Type: image/x-icon
</span>
<span class="repl-output">#(71 73 70 56 57 97 17 0 17 0 179 1 0 150 151 153 255 255 255 37 37 36 112 114 115 201 202 204
  0 0 0 80 83 84 26 28 26 230 231 231 249 249 249 12 13 14 219 221 222 18 21 22 239 240 241 52
  52 54 64 66 66 33 249 4 1 0 0 1 0 44 0 0 0 0 17 0 17 0 0 4 99 48 200 73 107 109 54 172 101
  129 120 196 180 12 12 51 80 64 161 42 3 48 28 170 106 72 141 16 223 120 113 166 121 95 0 14
  95 239 33 236 41 98 10 129 114 185 188 29 127 25 201 224 73 60 4 8 0 130 22 59 64 52 96 135
  148 35 96 80 152 159 186 192 64 183 112 0 200 61 65 0 1 192 76 214 185 113 102 241 88 26 90
  8 81 18 8 94 130 134 22 17 0 59)
200
((:DATE . "Sun, 09 Dec 2012 08:15:14 GMT") (:SERVER . "Apache/2")
 (:LAST-MODIFIED . "Sun, 01 Apr 2007 15:44:59 GMT") (:ETAG . "\"e2803c-b6-42d0efcaf94c0\"")
 (:ACCEPT-RANGES . "bytes") (:CONTENT-LENGTH . "182") (:VARY . "Accept-Encoding,User-Agent")
 (:CONNECTION . "close") (:CONTENT-TYPE . "image/x-icon"))
#&lt;URI http://zappa.com/favicon.ico&gt;
#&lt;FLEXI-STREAMS:FLEXI-IO-STREAM #x30200154D83D&gt;
T
"OK"</span>
</pre>
    
    <h4 xmlns=""><a name="ex-chunked-https">Chunked transfers and HTTPS</a></h4>

      Request a page using the HTTPS protocol.  Also note that the
      server uses <a name="chunked" href="http://www.rfc.net/rfc2616.html#s3.6.1">chunked transfer
      encoding</a> for its reply

      <pre><span class="repl-output">? </span><span class="repl-input">(ql:quickload :cl-ppcre)</span>
<span class="repl-output">To load "cl-ppcre":
  Load 1 ASDF system:
    cl-ppcre
; Loading "cl-ppcre"

(:CL-PPCRE)
? </span><span class="repl-input">(ppcre:scan-to-strings "(?s)You have.*your data."
                                       (drakma:http-request "https://www.fortify.net/cgi/ssl_2.pl"))</span>
<span class="headers-out">GET /cgi/ssl_2.pl HTTP/1.1
Host: www.fortify.net
User-Agent: Drakma/1.2.9 (Clozure Common Lisp Version 1.8-r15286M  (DarwinX8664); Darwin; 12.2.0; http://weitz.de/drakma/)
Accept: */*
Connection: close
</span>
<span class="headers-in">HTTP/1.1 200 OK
Date: Sun, 09 Dec 2012 08:15:31 GMT
Server: Apache
Connection: close
Transfer-Encoding: chunked
Content-Type: text/html
</span>
<span class="repl-output">"You have connected to this web server using the RC4-SHA encryption cipher
 with a key length of 128 bits.
 &lt;p&gt;
 This is a high-grade encryption connection, regarded by most experts as being suitable
 for sending or receiving even the most sensitive or valuable information
 across a network.
 &lt;p&gt;
 In a crude analogy, using this cipher is similar to sending or storing your data inside
 a high quality safe - compared to an export-grade cipher which is similar to using
 a paper envelope to protect your data."
#()</span>
</pre>
    
    <h4 xmlns=""><a name="ex-fake-ua">Faking a user agent header</a></h4>

      Some servers adapt their behavior according to the Browser that
      is used.  Drakma can claim to be i.e. MS Internet Explorer.

      <pre><span class="repl-output">? </span><span class="repl-input">(cl-ppcre:scan-to-strings "&lt;h4&gt;.*" (drakma:http-request "http://whatsmyuseragent.com/" :user-agent :explorer))</span>
<span class="headers-out">GET / HTTP/1.1
Host: whatsmyuseragent.com
User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; .NET CLR 1.1.4322; .NET CLR 2.0.50727)
Accept: */*
Connection: close
</span>
<span class="headers-in">HTTP/1.1 200 OK
Date: Sun, 09 Dec 2012 08:23:50 GMT
Server: Apache
X-Powered-By: PHP/5.2.17
Connection: close
Transfer-Encoding: chunked
Content-Type: text/html
</span>
<span class="repl-output">"&lt;h4&gt;Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; .NET CLR 1.1.4322; .NET CLR 2.0.50727)&lt;/h4&gt;"
#()</span>
</pre>
    
    <h4 xmlns=""><a name="ex-post-and-cookie">Posting data and using cookies</a></h4>
      Drakma can send parameters in a POST request and knows how to
      deal with <a href="#cookie">cookies</a>.  Note how Drakma sends
      the cookie back in the second request.

      <pre><span class="repl-output">? </span><span class="repl-input">(let ((cookie-jar (make-instance 'drakma:cookie-jar)))
    (drakma:http-request "http://www.phpsecurepages.com/test/test.php"
                         :method :post
                         :parameters '(("entered_login" . "test")
                                       ("entered_password" . "test"))
                         :cookie-jar cookie-jar)
    (drakma:http-request "http://www.phpsecurepages.com/test/test2.php"
                         :cookie-jar cookie-jar)
    (drakma:cookie-jar-cookies cookie-jar))</span>
<span class="headers-out">POST /test/test.php HTTP/1.1
Host: www.phpsecurepages.com
User-Agent: Drakma/1.2.9 (Clozure Common Lisp Version 1.8-r15286M  (DarwinX8664); Darwin; 12.2.0; http://weitz.de/drakma/)
Accept: */*
Connection: close
Content-Type: application/x-www-form-urlencoded
Content-Length: 40
</span>
<span class="headers-in">HTTP/1.1 200 OK
Date: Sun, 09 Dec 2012 08:25:13 GMT
Server:  
X-Powered-By: PHP/5.2.17
Set-Cookie: PHPSESSID=vijk3706eojs7n8u5cdpi3ju05; path=/
Expires: Thu, 19 Nov 1981 08:52:00 GMT
Cache-Control: no-store, no-cache, must-revalidate, post-check=0, pre-check=0
Pragma: no-cache
X-Powered-By: PleskLin
Content-Length: 4479
Connection: close
Content-Type: text/html
</span>
<span class="headers-out">GET /test/test2.php HTTP/1.1
Host: www.phpsecurepages.com
User-Agent: Drakma/1.2.9 (Clozure Common Lisp Version 1.8-r15286M  (DarwinX8664); Darwin; 12.2.0; http://weitz.de/drakma/)
Accept: */*
Cookie: PHPSESSID=vijk3706eojs7n8u5cdpi3ju05
Connection: close
</span>
<span class="headers-in">HTTP/1.1 200 OK
Date: Sun, 09 Dec 2012 08:25:16 GMT
Server:  
X-Powered-By: PHP/5.2.17
Expires: Thu, 19 Nov 1981 08:52:00 GMT
Cache-Control: no-store, no-cache, must-revalidate, post-check=0, pre-check=0
Pragma: no-cache
X-Powered-By: PleskLin
Content-Length: 4479
Connection: close
Content-Type: text/html
</span>
<span class="repl-output">(#&lt;COOKIE PHPSESSID=vijk3706eojs7n8u5cdpi3ju05; path=/; domain=www.phpsecurepages.com&gt;)</span>
</pre>
    
    <h4 xmlns=""><a name="ex-reuse-connection">Reusing a connection to a server</a></h4>

      Drakma can <a name="re-use">use</a> a connection to a server for multiple requests.

      <pre><span class="repl-output">? </span><span class="repl-input">(let ((stream (nth-value 4 (drakma:http-request "http://www.lispworks.com/" :close nil))))
    (nth-value 2 (drakma:http-request "http://www.lispworks.com/success-stories/index.html"
                                      :stream stream)))</span>
<span class="headers-out">GET / HTTP/1.1
Host: www.lispworks.com
User-Agent: Drakma/1.2.9 (Clozure Common Lisp Version 1.8-r15286M  (DarwinX8664); Darwin; 12.2.0; http://weitz.de/drakma/)
Accept: */*
</span>
<span class="headers-in">HTTP/1.1 200 OK
Date: Sun, 09 Dec 2012 08:25:56 GMT
Server: Apache/2.2.22 (Unix) mod_ssl/2.2.22 OpenSSL/1.0.1c mod_apreq2-20051231/2.6.0 mod_perl/2.0.5 Perl/v5.8.9
Last-Modified: Tue, 20 Nov 2012 12:27:40 GMT
ETag: "336280-28eb-4ceec5c1f4700"
Accept-Ranges: bytes
Content-Length: 10475
Content-Type: text/html
</span>
<span class="headers-out">GET /success-stories/index.html HTTP/1.1
Host: www.lispworks.com
User-Agent: Drakma/1.2.9 (Clozure Common Lisp Version 1.8-r15286M  (DarwinX8664); Darwin; 12.2.0; http://weitz.de/drakma/)
Accept: */*
Connection: close
</span>
<span class="headers-in">HTTP/1.1 200 OK
Date: Sun, 09 Dec 2012 08:25:56 GMT
Server: Apache/2.2.22 (Unix) mod_ssl/2.2.22 OpenSSL/1.0.1c mod_apreq2-20051231/2.6.0 mod_perl/2.0.5 Perl/v5.8.9
Last-Modified: Tue, 20 Nov 2012 12:28:52 GMT
ETag: "336386-2940-4ceec6069e900"
Accept-Ranges: bytes
Content-Length: 10560
Connection: close
Content-Type: text/html
</span>
<span class="repl-output">((:DATE . "Sun, 09 Dec 2012 08:25:56 GMT")
 (:SERVER . "Apache/2.2.22 (Unix) mod_ssl/2.2.22 OpenSSL/1.0.1c mod_apreq2-20051231/2.6.0 mod_perl/2.0.5 Perl/v5.8.9")
 (:LAST-MODIFIED . "Tue, 20 Nov 2012 12:28:52 GMT") (:ETAG . "\"336386-2940-4ceec6069e900\"") (:ACCEPT-RANGES . "bytes")
 (:CONTENT-LENGTH . "10560") (:CONNECTION . "close") (:CONTENT-TYPE . "text/html"))</span>
</pre>
    
    <h4 xmlns=""><a name="ex-basic-auth">Basic Authorization</a></h4>

      Drakma supports basic authorization.  In this example, we use a
      locally running <a href="http://weitz.de/hunchentoot">Hunchentoot</a> server.

      <pre><span class="repl-output">? </span><span class="repl-input">(ql:quickload :hunchentoot-test)</span>
<span class="repl-output">To load "hunchentoot-test":
  Load 4 ASDF systems:
    cl-ppcre cl-who drakma hunchentoot
  Install 1 Quicklisp release:
    hunchentoot
; Loading "hunchentoot-test"
To load "trivial-backtrace":
  Install 1 Quicklisp release:
    trivial-backtrace
; Loading "trivial-backtrace"
[package trivial-backtrace]..
; Loading "hunchentoot-test"
To load "md5":
  Install 1 Quicklisp release:
    md5
; Loading "md5"
[package md5]..............
; Loading "hunchentoot-test"
To load "cl-fad":
  Install 1 Quicklisp release:
    cl-fad
; Loading "cl-fad"
[package cl-fad]..................................
[package cl-fad-test].............................
[package cl-fad-ccl].
; Loading "hunchentoot-test"

(:HUNCHENTOOT-TEST)
? </span><span class="repl-input">(hunchentoot:start (make-instance 'hunchentoot:easy-acceptor :port 4242))</span>
<span class="repl-output">#&lt;EASY-ACCEPTOR (host *, port 4242)&gt;
? </span><span class="repl-input">(nth-value 1 (drakma:http-request "http://localhost:4242/hunchentoot/test/authorization.html"))</span>
<span class="headers-out">GET /hunchentoot/test/authorization.html HTTP/1.1
Host: localhost:4242
User-Agent: Drakma/1.2.9 (Clozure Common Lisp Version 1.8-r15286M  (DarwinX8664); Darwin; 12.2.0; http://weitz.de/drakma/)
Accept: */*
Connection: close
</span>
<span class="repl-output">127.0.0.1 - [2012-12-09 09:27:40] "GET /hunchentoot/test/authorization.html HTTP/1.1" 401 543 "-" "Drakma/1.2.9 (Clozure Common Lisp Version 1.8-r15286M  (DarwinX8664); Darwin; 12.2.0; http://weitz.de/drakma/)"</span>
<span class="headers-in">HTTP/1.1 401 Authorization Required
Content-Length: 543
Date: Sun, 09 Dec 2012 08:27:40 GMT
Server: Hunchentoot 1.2.5
Connection: Close
Www-Authenticate: Basic realm="Hunchentoot"
Content-Type: text/html; charset=iso-8859-1
</span>
<span class="repl-output">401
? </span><span class="repl-input">(nth-value 1 (drakma:http-request "http://localhost:4242/hunchentoot/test/authorization.html"
                                            :basic-authorization '("nanook" "igloo")))</span>
<span class="headers-out">GET /hunchentoot/test/authorization.html HTTP/1.1
Host: localhost:4242
User-Agent: Drakma/1.2.9 (Clozure Common Lisp Version 1.8-r15286M  (DarwinX8664); Darwin; 12.2.0; http://weitz.de/drakma/)
Authorization: Basic bmFub29rOmlnbG9v
Accept: */*
Connection: close
</span>
<span class="repl-output">127.0.0.1 nanook [2012-12-09 09:28:15] "GET /hunchentoot/test/authorization.html HTTP/1.1" 200 907 "-" "Drakma/1.2.9 (Clozure Common Lisp Version 1.8-r15286M  (DarwinX8664); Darwin; 12.2.0; http://weitz.de/drakma/)"</span>
<span class="headers-in">HTTP/1.1 200 OK
Content-Length: 907
Date: Sun, 09 Dec 2012 08:28:15 GMT
Server: Hunchentoot 1.2.5
Connection: Close
Content-Type: text/html; charset=utf-8
</span>
<span class="repl-output">200</span>
</pre>
    
    <h4 xmlns=""><a name="ex-response-stream">Reading the response from a stream</a></h4>

      Drakma can return a stream to the application so that the reply
      is not completely buffered in memory first.

      <pre><span class="repl-output">? </span><span class="repl-input">(let ((stream (drakma:http-request "http://www.quicklisp.org"
                                     :want-stream t)))
                   (loop for i below 41
                         for line = (read-line stream)
                         when (&gt; i 35)
                         do (write-line line))
                   (close stream)
                   (values))</span>
<span class="headers-out">GET / HTTP/1.1
Host: www.quicklisp.org
User-Agent: Drakma/1.2.9 (Clozure Common Lisp Version 1.8-r15286M  (DarwinX8664); Darwin; 12.2.0; http://weitz.de/drakma/)
Accept: */*
Connection: close
</span>
<span class="headers-in">HTTP/1.1 200 OK
Server: nginx/1.1.17
Date: Sun, 09 Dec 2012 08:29:45 GMT
Content-Type: text/html
Content-Length: 1993
Last-Modified: Wed, 04 Jan 2012 14:42:40 GMT
Connection: close
Accept-Ranges: bytes
</span>
<span class="repl-output">
&lt;p&gt;For the latest Quicklisp news,
see &lt;a href="http://twitter.com/quicklisp"&gt;@quicklisp&lt;/a&gt; on twitter
or &lt;a href="http://blog.quicklisp.org/"&gt;the Quicklisp blog&lt;/a&gt;.
</span>
</pre>
    
    <h4 xmlns=""><a name="ex-assemble-request-content">Piecemeal assembly of request contents</a></h4>

      Request contents can be assembled from various source, and
      chunked encoding can be used by request bodies.  Many servers do
      not support chunked encoding for request bodies, though.

      <pre><span class="repl-output">? </span><span class="repl-input">(let ((temp-file (ensure-directories-exist #p"/tmp/quux.txt"))
        (continuation (drakma:http-request "http://localhost:4242/hunchentoot/test/parameter_latin1_post.html"
                                           :method :post
                                           :content :continuation)))
    (funcall continuation "foo=" t)
    (funcall continuation (list (char-code #\z) (char-code #\a)) t)
    (funcall continuation (lambda (stream)
                            (write-char #\p stream)) t)
    (with-open-file (out temp-file
                         :direction :output
                         :if-does-not-exist :create
                         :if-exists :supersede)
      (write-string "p" out))
    (funcall continuation temp-file t)
    (ppcre:scan-to-strings "zappzerapp" (funcall continuation "zerapp")))</span>
<span class="headers-out">POST /hunchentoot/test/parameter_latin1_post.html HTTP/1.1
Host: localhost:4242
User-Agent: Drakma/1.2.9 (Clozure Common Lisp Version 1.8-r15286M  (DarwinX8664); Darwin; 12.2.0; http://weitz.de/drakma/)
Accept: */*
Connection: close
Content-Type: application/x-www-form-urlencoded
Transfer-Encoding: chunked
</span>
<span class="repl-output">127.0.0.1 - [2012-12-09 10:06:44] "POST /hunchentoot/test/parameter_latin1_post.html HTTP/1.1" 200 1312 "-" "Drakma/1.2.9 (Clozure Common Lisp Version 1.8-r15286M  (DarwinX8664); Darwin; 12.2.0; http://weitz.de/drakma/)"</span>
<span class="headers-in">HTTP/1.1 200 OK
Content-Length: 1312
Date: Sun, 09 Dec 2012 09:06:44 GMT
Server: Hunchentoot 1.2.5
Connection: Close
Last-Modified: Sun, 09 Dec 2012 09:06:44 GMT
Pragma: no-cache
Cache-Control: no-store, no-cache, must-revalidate, post-check=0, pre-check=0
Expires: Mon, 26 Jul 1997 05:00:00 GMT
Content-Type: text/html; charset=ISO-8859-1
</span>
<span class="repl-output">"zappzerapp"
#()</span>
</pre>
    
    <h4 xmlns=""><a name="ex-partial-transfers">Partial transfers</a></h4>

      <a href="http://www.rfc.net/rfc2616.html#s14.35">Partial
      transfers</a> of resources are possible.

      <pre><span class="repl-output">? </span><span class="repl-input">(ppcre:regex-replace-all
   "&lt;.*?&gt;"
   (format nil "~A~%~A"
           (drakma:http-request "http://members.shaw.ca/mitb/hunchentoot.html"
                                :additional-headers '(("Range" . "bytes=998-1034")))
           (drakma:http-request "http://members.shaw.ca/mitb/hunchentoot.html"
                                :additional-headers '(("Range" . "bytes=1213-1249"))))
   "")</span>
<span class="headers-out">GET /mitb/hunchentoot.html HTTP/1.1
Host: members.shaw.ca
User-Agent: Drakma/1.2.9 (Clozure Common Lisp Version 1.8-r15286M  (DarwinX8664); Darwin; 12.2.0; http://weitz.de/drakma/)
Accept: */*
Connection: close
Range: bytes=998-1034
</span>
<span class="headers-in">HTTP/1.1 206 Partial Content
Date: Sun, 09 Dec 2012 09:16:16 GMT
Server: Apache/2.2.20 (Unix) mod_ldap_userdir/1.1.17
Last-Modified: Wed, 14 Mar 2012 23:22:04 GMT
ETag: "3b7eed-3238-4bb3c3e453f00"
Accept-Ranges: bytes
Content-Length: 37
Content-Range: bytes 998-1034/12856
Content-Type: text/html
Connection: close
</span>
<span class="headers-out">GET /mitb/hunchentoot.html HTTP/1.1
Host: members.shaw.ca
User-Agent: Drakma/1.2.9 (Clozure Common Lisp Version 1.8-r15286M  (DarwinX8664); Darwin; 12.2.0; http://weitz.de/drakma/)
Accept: */*
Connection: close
Range: bytes=1213-1249
</span>
<span class="headers-in">HTTP/1.1 206 Partial Content
Date: Sun, 09 Dec 2012 09:16:16 GMT
Server: Apache/2.2.20 (Unix) mod_ldap_userdir/1.1.17
Last-Modified: Wed, 14 Mar 2012 23:22:04 GMT
ETag: "3b7eed-3238-4bb3c3e453f00"
Accept-Ranges: bytes
Content-Length: 37
Content-Range: bytes 1213-1249/12856
Content-Type: text/html
</span>
<span class="repl-output">"DRAKMA (Queen of Cosmic Greed)
HUNCHENTOOT (The Giant Spider)"
T</span>
</pre>
    

  
</body></html>
